<%- o = form.object -%>
<%- n = fields_for -%>
<div id="<%= n %>" class="nested_fields">
  <%- item = o.send(n) -%>
  <%- unless item -%>
      <%- item = new_item = o.send("build_#{n.to_s}".to_sym) -%>
      <%- index = Time.now.to_i.to_s -%>
  <% end %>  
  <%- really_new = (item.new_record? and item == new_item) %>
  <%- my_dom_id = ((!item.new_record? or really_new) ? dom_id(item) : dom_class(item) + "_" + index) %>
     <%= item.class.human_name %>
    <%- form.fields_for n, item, :child_index => (item.new_record? ? my_dom_id : nil) do |n_form| %>
      <%= render :partial => "#{n.to_s.pluralize}/form", :object => n_form %>
      <%- unless item.new_record? %>
        <%= n_form.label :_delete %>
        <%= n_form.check_box :_delete %>
      <% end %>
     <% end %>
      <p class="j_unhide">
      <%- # because we replace new_item (the dom id) with a new index with javascript so we put dom_class before %>
        <%= link_to t(:delete), (really_new ? "##{dom_class(item)}_#{dom_id(item)}" : "##{my_dom_id}"), :class => "delete_#{item.new_record? ? "new_record_" : ""}links" %>
  <%- if item.new_record? %>
    <%= link_to t(:new_item, :item => new_item.class.human_name), "#new_#{dom_class(new_item)}", :class => "new_nested_fields_links" %>
  <% end %>

